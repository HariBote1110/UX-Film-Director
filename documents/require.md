承知いたしました。
これまでの開発状況（特にPSDと.labのパーサー選定）を踏まえて、要件定義書を更新します。

開発の中断、了解いたしました。再開される際も、ぜひお声がけください。

---

# UX Film Director 要件定義書 (2025-11-06 更新)

## 1. プロジェクト概要

| 項目 | 詳細 |
| :--- | :--- |
| **プロジェクト名** | UX Film Director |
| **開発組織** | UX Labs |
| **目的** | シンプルな操作で、VOICEROID（ボイロ）動画制作を効率化するためのMac向け動画編集ソフトウェアの開発。 |
| **コア技術** | Swift (macOSネイティブ)、ffmpegのラッパーとしての機能実装。 |
| **対象プラットフォーム** | macOS |

---

## 2. 目標とコンセプト

* **メインゴール:** 従来の動画編集ソフトよりも、ボイロ動画特有の作業（キャラクターの静止画表示、音声と口パクの同期）を大幅に簡略化する。
* **コンセプト:** 「**素材を配置するだけで、キャラクターが喋り出す**」自動ディレクション機能を持つエディタ。

---

## 3. 主要機能要件

### 3.1. タイムラインと編集機能

| ID | 機能名 | 詳細 |
| :--- | :--- | :--- |
| F-01 | 基本編集機能 | カット、トリム、結合など、動画編集の基本的な操作をGUIで提供する。 |
| F-02 | トラック管理 | 動画トラック、音声トラック、静止画/レイヤートラックなどの複数トラックをサポートする。 |
| F-03 | プレビュー機能 | タイムラインの編集内容をリアルタイムでプレビューできる機能。 |
| F-04 | 書き出し（エクスポート） | 編集後のプロジェクトを、**Swiftからffmpegを呼び出し** て一般的な動画ファイル形式（MP4など）で書き出せる機能。 |

### 3.2. VOICEROID動画制作特化機能

| ID | 機能名 | 詳細 |
| :--- | :--- | :--- |
| F-05 | **PSDファイルサポート** | キャラクターの立ち絵や表情差分が含まれたPSDファイルを読み込み、レイヤー単位でタイムライン上に配置・管理できる。 |
| F-06 | **自動タイムライン配置 (中核機能)** | 特定のディレクトリ構造に基づき、音声ファイルと口パクデータを自動で読み込み、以下の要素をタイムラインに一括で配置する。 |
| F-07 | **音声ファイル配置** | 関連する音声ファイル（WAV, MP3など）をタイムラインの指定位置に自動で配置する。 |
| F-08 | **口パク同期自動配置** | 読み込んだ`.lab`ファイルの情報に基づき、音声のタイミングに合わせて、PSDファイル内の対応する「口」のレイヤーを自動で切り替えるキーフレームを生成・配置する。 |
| F-09 | **表情差分連動（拡張）** | `.lab`ファイルや特定のファイル名規則に基づき、口パクだけでなく「目」などの表情差分レイヤーの自動切り替えにも対応する。 |

### 3.3. UI/UX 要件 (新規追加) 🖥️

| ID | 機能名 | 詳細 |
| :--- | :--- | :--- |
| U-01 | **UIスタイル** | ユーザーインターフェースは、**AviUtlに近いレイアウトと色調**（例：ダークテーマ、シンプルなウィンドウ構成）を採用し、ボイロ動画制作者に馴染みやすい操作感を目指す。 |
| U-02 | **PSDToolKit風の表情変更** | タイムライン上でPSDファイルを参照するクリップを選択した際、**PSDToolKitのように**、**レイヤーグループ** や **差分名** が一覧表示される専用のパネルを画面上に表示する。 |
| U-03 | **簡単表情切り替え** | U-02のパネルで、クリック一つで、現在のタイムラインカーソル位置に「目」「眉」「口」などの**表情グループの表示レイヤーを切り替えるキーフレーム** を自動で挿入できるようにする。 |
| U-04 | **視覚的なキーフレーム** | 表情が切り替わるキーフレームはタイムライン上にアイコンなどで視覚的に表示され、クリック/ドラッグで簡単に編集できるようにする。 |

---

## 4. 技術要件

### 4.1. データ仕様：口パクファイル (`.lab`)

| 項目 | 詳細 |
| :--- | :--- |
| **ファイル形式** | 拡張子 `.lab` のテキストファイル |
| **書式** | `[開始時刻] [終了時刻] [音素]` |
| **時刻単位** | **100ナノ秒単位** (例: $1040000$ は $0.104$秒 = $104$ミリ秒) |
| **音素** | `a`, `i`, `u`, `e`, `o` などの母音、`f`, `h` などの子音、`pau` (ポーズ) などを識別し、対応するPSDレイヤーに変換する。 |

### 4.2. 開発要件

* **基盤技術:** **Swift (SwiftUI)** を使用したmacOSネイティブアプリケーションとして開発する。
* **ffmpeg連携:** 動画のエンコード/デコード、編集操作の結果を反映するために、**ffmpegをライブラリまたはコマンドラインとして内部でラッピング** して使用する。
* **PSD処理:** PSDファイルをパースし、レイヤー情報（レイヤー名、可視性、位置、画像データ）を取得できること。特に、**レイヤーグループ名** を解析し、表情の差分管理（PSDToolKitと同様のグループ化）に利用できることが必須。

---

## 5. 開発ログ (2025-11-06現在)
ここまでの進捗と技術選定の経緯を記録する。

### 5.1. アーキテクチャ選定

* **Swift vs Electron:**
    * UI開発速度の利点からElectronも検討したが、要件F-03（リアルタイムプレビュー）およびF-08（100ナノ秒単位のキーフレーム処理）のパフォーマンス要件を満たすため、**Swift (SwiftUI)** を採用と決定。
* **ベースUI:**
    * SwiftUIによる3ペインレイアウト（メディアプール、プレビュー/タイムライン、インスペクタ）のベースコードを作成済み。

### 5.2. 中核機能の進捗

* **`.lab`パーサー (F-08関連):**
    * `LabParser.swift` を作成済み。
    * `String` を `[LabEntry]` 構造体配列（秒単位に変換済み）にパースするロジックの実装完了。
    * `ContentView` にファイル選択ダイアログとテストロジックを実装し、動作確認済み。

* **PSDパーサー (F-05関連):**
    * **技術選定に時間を要した**。
    * **Plan A (Cライブラリ):** `vurtun/psd` (C言語) をブリッジングする案を検討したが、リポジトリが非公開となり断念。
    * **Plan B (Swiftライブラリ):** `hughbe/PhotoshopReader` (Swift) を導入したが、ライブラリが5年以上更新されておらず、最新のPSDファイル（単純なファイル含む）の読み込みに失敗 (`PhotoshopReadError error 0`) したため、使用を断念。
